name: CI + GitOps (ArgoCD pull-based)

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

concurrency:
  group: hello-gitops-main
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  ci:
    name: Lint/Test + Build (push image only on main)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies (optional CI)
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f cicd_cloud_kubernetes/requirements.txt ]; then pip install -r cicd_cloud_kubernetes/requirements.txt; fi

      - name: Lint with flake8 (optional)
        run: |
          cd cicd_cloud_kubernetes
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Test with pytest (optional)
        run: |
          cd cicd_cloud_kubernetes
          pytest || true

      - name: Log in to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push image (tagged by commit SHA)
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: ./cicd_cloud_kubernetes/app
          file: ./cicd_cloud_kubernetes/app/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/hello-gitops:${{ github.sha }}
          platforms: linux/amd64

  gitops:
    name: Update manifests (desired state) for ArgoCD
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push'

    env:
      NAMESPACE: hello-gitops
      IMAGE_NEW: ${{ secrets.DOCKER_USERNAME }}/hello-gitops:${{ github.sha }}
      FINAL_REPLICAS: "1"
      OLD_REPLICAS: "0"

    steps:
      - name: Checkout repository (with push rights)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo curl -L -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Compute ACTIVE/NEW color from service.yaml (from Git, not cluster)
        id: colors
        run: |
          set -euo pipefail
          SVC="cicd_cloud_kubernetes/k8s/service.yaml"
          ACTIVE="$(yq -r '.spec.selector.color // "blue"' "$SVC")"
          if [ "$ACTIVE" = "blue" ]; then NEW="green"; else NEW="blue"; fi
          echo "ACTIVE_COLOR=$ACTIVE" >> $GITHUB_ENV
          echo "NEW_COLOR=$NEW" >> $GITHUB_ENV
          echo "Active color (from Git): $ACTIVE"
          echo "New color:               $NEW"

      - name: Update manifests (image + replicas + service selector)
        run: |
          set -euo pipefail

          DEPLOY_NEW="cicd_cloud_kubernetes/k8s/deployment-${NEW_COLOR}.yaml"
          DEPLOY_OLD="cicd_cloud_kubernetes/k8s/deployment-${ACTIVE_COLOR}.yaml"
          SVC="cicd_cloud_kubernetes/k8s/service.yaml"

          echo "Patching $DEPLOY_NEW -> image=${IMAGE_NEW}, replicas=${FINAL_REPLICAS}"
          IMAGE_NEW="${IMAGE_NEW}" FINAL_REPLICAS="${FINAL_REPLICAS}" yq -i '
            (.spec.template.spec.containers[] | select(.name == "hello-gitops") | .image) = strenv(IMAGE_NEW) |
            .spec.replicas = (strenv(FINAL_REPLICAS) | tonumber)
          ' "$DEPLOY_NEW"

          echo "Patching $DEPLOY_OLD -> replicas=${OLD_REPLICAS}"
          OLD_REPLICAS="${OLD_REPLICAS}" yq -i '
            .spec.replicas = (strenv(OLD_REPLICAS) | tonumber)
          ' "$DEPLOY_OLD"

          echo "Switching service selector -> color=${NEW_COLOR}"
          NEW_COLOR="${NEW_COLOR}" yq -i '
            .spec.selector.color = strenv(NEW_COLOR)
          ' "$SVC"

      - name: Commit & push desired state
        run: |
          set -euo pipefail
          git status --porcelain

          if git diff --quiet; then
            echo "No manifest changes to commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add cicd_cloud_kubernetes/k8s/*.yaml
          git commit -m "gitops: promote ${GITHUB_SHA} -> ${NEW_COLOR}"
          git push